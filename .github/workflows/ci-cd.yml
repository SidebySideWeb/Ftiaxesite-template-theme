permissions:
  security-events: write
name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
      - name: ğŸ“š Install dependencies
        run: pnpm install
      - name: ğŸ¨ Lint code
        run: pnpm run lint
      - name: ğŸ” Type check
        run: pnpm exec tsc --noEmit
      # - name: ğŸ”’ Security audit
      #   run: npm audit --audit-level high
      - name: ğŸ“Š Bundle analysis
        run: SKIP_PAYLOAD_BUILD=1 pnpm run build
        env:
          NODE_ENV: production
          PAYLOAD_SECRET: test-secret-key-for-ci
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          NEXT_PUBLIC_SITE_URL: http://localhost:3000

  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
      - name: ğŸ“š Install dependencies
        run: pnpm install
      - name: ğŸ§ª Run tests
        run: pnpm test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          PAYLOAD_SECRET: test-secret-key
          NODE_ENV: test

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: ğŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs:
      - quality
      - test
      - security
    if: always()
    steps:
      - name: ğŸ“¢ Notify on success
        if: ${{ success() }}
        run: |
          echo "âœ… CI/CD pipeline completed successfully!"
          # Add Slack/Discord notification here if needed
      - name: ğŸ“¢ Notify on failure
        if: ${{ failure() }}
        run: |
          echo "âŒ CI/CD pipeline failed!"
          # Add Slack/Discord notification here if needed
