name: 📊 Performance Monitoring

on:
  schedule:
    # Run performance checks daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  lighthouse:
    name: 🔍 Lighthouse Audit
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        url:
          - 'https://your-domain.vercel.app'
          - 'https://your-domain.vercel.app/admin'
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔍 Run Lighthouse
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: ${{ matrix.url }}
        configPath: './lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true

  core-web-vitals:
    name: ⚡ Core Web Vitals
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 📚 Install dependencies
      run: npm ci

    - name: ⚡ Measure Core Web Vitals
      run: |
        npm install -g web-vitals-cli
        web-vitals https://your-domain.vercel.app --json > vitals.json

    - name: 📊 Upload metrics
      uses: actions/upload-artifact@v4
      with:
        name: core-web-vitals
        path: vitals.json

  bundle-analysis:
    name: 📦 Bundle Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 📚 Install dependencies
      run: npm ci

    - name: 🏗️ Build and analyze
      run: npm run analyze
      env:
        PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET_TEST }}
        DATABASE_URL: ${{ secrets.DATABASE_URL_TEST }}
        NEXT_PUBLIC_SITE_URL: https://your-domain.vercel.app

    - name: 📊 Upload bundle stats
      uses: actions/upload-artifact@v4
      with:
        name: bundle-analysis
        path: .next/analyze/

  accessibility:
    name: ♿ Accessibility Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 📚 Install dependencies
      run: npm ci

    - name: ♿ Run axe accessibility tests
      run: |
        npm install -g @axe-core/cli
        axe https://your-domain.vercel.app --tags wcag2a,wcag2aa --format json > accessibility.json

    - name: 📊 Upload accessibility report
      uses: actions/upload-artifact@v4
      with:
        name: accessibility-report
        path: accessibility.json

  report:
    name: 📈 Generate Report
    runs-on: ubuntu-latest
    needs: [lighthouse, core-web-vitals, bundle-analysis, accessibility]
    
    steps:
    - name: 📥 Download all artifacts
      uses: actions/download-artifact@v4

    - name: 📈 Generate performance report
      run: |
        echo "# 📊 Daily Performance Report" > report.md
        echo "" >> report.md
        echo "Generated on: $(date)" >> report.md
        echo "" >> report.md
        echo "## 🔍 Lighthouse Scores" >> report.md
        echo "- Performance: Check artifacts" >> report.md
        echo "- Accessibility: Check artifacts" >> report.md
        echo "- Best Practices: Check artifacts" >> report.md
        echo "- SEO: Check artifacts" >> report.md
        echo "" >> report.md
        echo "## ⚡ Core Web Vitals" >> report.md
        echo "- LCP: Check vitals.json" >> report.md
        echo "- FID: Check vitals.json" >> report.md
        echo "- CLS: Check vitals.json" >> report.md
        echo "" >> report.md
        echo "## 📦 Bundle Size" >> report.md
        echo "- Total Size: Check bundle analysis" >> report.md
        echo "- JavaScript: Check bundle analysis" >> report.md
        echo "- CSS: Check bundle analysis" >> report.md

    - name: 📊 Upload performance report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: report.md